/*! tabex 1.0.0 https://github.com//nodeca/tabex @license MIT */
!function(_){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=_();else if("function"==typeof define&&define.amd)define([],_);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.tabex=_()}}(function(){return function _(e,t,n){function i(r,a){if(!t[r]){if(!e[r]){var o="function"==typeof require&&require;if(!a&&o)return o(r,!0);if(s)return s(r,!0);var h=new Error("Cannot find module '"+r+"'");throw h.code="MODULE_NOT_FOUND",h}var c=t[r]={exports:{}};e[r][0].call(c.exports,function(_){var t=e[r][1][_];return i(t?t:_)},c,c.exports,_,e,t,n)}return t[r].exports}for(var s="function"==typeof require&&require,r=0;r<n.length;r++)i(n[r]);return i}({1:[function(_,e){"use strict";e.exports=_("./lib")},{"./lib":3}],2:[function(_,e){"use strict";function t(_){var e=this;this.__filters_in__=[],this.__filters_out__=[],this.__subscriptions__=[],this.__node_id__=Math.floor(1e10*Math.random())+1,this.__last_message_cnt__=0,this.__ignore_list__={},this.__router__=_.router,this.__router__.onmessage(function(_,t){e.__onmessage__(_,t)})}var n=_("./utils");t.prototype.emit=function(_,e,t){var i=this,s={id:this.__node_id__+"_"+this.__last_message_cnt__++,node_id:this.__node_id__,data:e};t||(this.__ignore_list__[s.id]=!0),n.asyncEach(this.__filters_out__,_,s,function(_,e){i.__router__.broadcast(_,e)})},t.prototype.on=function(_,e){return this.__subscriptions__.push({channel:_,handler:e}),this.emit("!sys.channels.add",{channel:_}),this},t.prototype.off=function(_,e){var t=this;this.__subscriptions__=this.__subscriptions__.reduce(function(n,i){return i.channel!==_||e&&e!==i.handler?(n.push(i),n):(t.emit("!sys.channels.remove",{channel:_}),n)},[])},t.prototype.filterIn=function(_){return this.__filters_in__.push(_),this},t.prototype.filterOut=function(_){return this.__filters_out__.push(_),this},t.prototype.__onmessage__=function(_,e){var t=this;n.asyncEach(this.__filters_in__,_,e,function(_,e){t.__ignore_list__[e.id]||t.__subscriptions__.forEach(function(t){t.channel===_&&t.handler(e.data,_)})})},e.exports=t},{"./utils":7}],3:[function(_,e){"use strict";var t=_("./router"),n=_("./client"),i=_("./tunnel"),s={},r={_:{}};r._.Router=t,r._.Client=n,r._.Tunnel=i,r.client=function(_){_=_||{};var e,r=_.namespace||"tabex_default_";return _.iframe?e=new i.TunnelClient(_):(s[r]||(s[r]=new t({namespace:r})),e=s[r]),new n({router:e})},r.router=function(_){_=_||{};var e=_.namespace||"tabex_default_";return s[e]||(s[e]=new t({namespace:e})),new i.TunnelRouter({router:s[e],origin:_.origin}),s[e]},e.exports=r},{"./client":2,"./router":5,"./tunnel":6}],4:[function(_,e){"use strict";function t(){}var n=window.localStorage,i={},s=function(){if(!n)return!1;try{n.setItem("live_local_storage_is_writable_test",""),n.removeItem("live_local_storage_is_writable_test")}catch(_){return!1}return!0}();Object.defineProperty(t.prototype,"length",{get:function(){return s?n.length:Object.keys(i).length}}),t.prototype.getItem=function(_){return s?n.getItem(_):i.hasOwnProperty(_)?i[_]:null},t.prototype.setItem=function(_,e){s?n.setItem(_,e):i[_]=e},t.prototype.removeItem=function(_){s?n.removeItem(_):i[_]=null},t.prototype.key=function(_){return s?n.key(_):Object.keys(i)[_]},e.exports=t},{}],5:[function(_,e){"use strict";function t(_){var e=this;_=_||{},this.__namespace__=_.namespace||"tabex_default_",this.__node_id__=Math.floor(1e10*Math.random())+1,this.__last_message_cnt__=0,this.__handlers__=[],this.__router_id_prefix__=this.__namespace__+"router_",this.__router_channels_prefix__=this.__namespace__+"subscribed_",this.__router_channels__={},this.__ls__=new n,this.__master_id__=null,window.addEventListener("storage",function(_){setTimeout(function(){e.__on_changed__(_)},1)}),this.__destroyed__=!1,window.addEventListener("beforeunload",this.__destroy__.bind(this)),window.addEventListener("unload",this.__destroy__.bind(this)),this.__check_master__(),setInterval(this.__check_master__.bind(this),s)}var n=_("./local_storage"),i=4e3,s=i/4;t.prototype.broadcast=function(_,e){return"!sys.channels.add"===_?(this.__router_channels__[e.data.channel]=this.__router_channels__[e.data.channel]||0,this.__router_channels__[e.data.channel]++,void this.__update_channels_list__()):"!sys.channels.remove"===_?(this.__router_channels__[e.data.channel]=this.__router_channels__[e.data.channel]||0,this.__router_channels__[e.data.channel]--,void this.__update_channels_list__()):(this.__ls__.setItem(this.__namespace__+"broadcast",JSON.stringify({channel:_,message:e,random:Math.floor(1e10*Math.random())})),void this.__handlers__.forEach(function(t){t(_,e)}))},t.prototype.onmessage=function(_){var e=this;this.__handlers__.push(_),setTimeout(function(){_("!sys.master",{data:{node_id:e.__node_id__,master_id:e.__master_id__},node_id:e.__node_id__,id:e.__node_id__+"_"+e.__last_message_cnt__++}),e.__on_channels_list_changed__()},0)},t.prototype.__on_master_changed__=function(_){var e=this;return _?(this.__master_id__=+_,void this.__handlers__.forEach(function(_){_("!sys.master",{data:{node_id:e.__node_id__,master_id:e.__master_id__},node_id:e.__node_id__,id:e.__node_id__+"_"+e.__last_message_cnt__++})})):void(this.__get_alive_router_ids__().sort()[0]===this.__node_id__&&(this.__ls__.setItem(this.__namespace__+"master",this.__node_id__),this.__on_master_changed__(this.__node_id__)))},t.prototype.__on_data_changed__=function(_){var e=JSON.parse(_);this.__receive_message__(e.channel,e.message)},t.prototype.__on_changed__=function(_){if(_.key===this.__namespace__+"master"&&this.__on_master_changed__(_.newValue),_.key===this.__namespace__+"message"&&this.__on_data_changed__(_.newValue),0===_.key.indexOf(this.__router_channels_prefix__)&&this.__on_channels_list_changed__(),_.key===this.__namespace__+"broadcast"){var e=JSON.parse(_.newValue);this.__handlers__.forEach(function(_){_(e.channel,e.message)})}},t.prototype.__destroy__=function(){this.__destroyed__||(this.__destroyed__=!0,this.__ls__.removeItem(this.__router_id_prefix__+this.__node_id__),this.__ls__.removeItem(this.__router_channels_prefix__+this.__node_id__),this.__master_id__===this.__node_id__&&this.__ls__.removeItem(this.__namespace__+"master"))},t.prototype.__get_alive_router_ids__=function(){for(var _,e,t=Date.now()-i,n=[],s=0;s<this.__ls__.length;s++)e=this.__ls__.key(s),0===e.indexOf(this.__router_id_prefix__)&&(_=+e.substr(this.__router_id_prefix__.length),this.__ls__.getItem(e)<t?(this.__ls__.removeItem(e),this.__ls__.removeItem(this.__router_channels_prefix__+_)):n.push(_));return n},t.prototype.__update_channels_list__=function(){var _=this,e=[];Object.keys(this.__router_channels__).forEach(function(t){_.__router_channels__[t]>0&&e.push(t)});var t=JSON.stringify(e.sort());this.__ls__.getItem(this.__router_channels_prefix__+this.__node_id__)!==t&&(this.__ls__.setItem(this.__router_channels_prefix__+this.__node_id__,t),this.__on_channels_list_changed__())},t.prototype.__on_channels_list_changed__=function(){for(var _,e=this,t=[],n=0;n<this.__ls__.length;n++)_=this.__ls__.key(n),0===_.indexOf(this.__router_channels_prefix__)&&(t=t.concat(JSON.parse(this.__ls__.getItem(_))));t=t.reduce(function(_,e){return-1===_.indexOf(e)&&_.push(e),_},[]),this.__handlers__.forEach(function(_){_("!sys.channels.refresh",{id:e.__node_id__+"_"+e.__last_message_cnt__++,node_id:e.__node_id__,data:{channels:t}})})},t.prototype.__check_master__=function(){this.__ls__.setItem(this.__router_id_prefix__+this.__node_id__,Date.now()),this.__master_id__=+this.__ls__.getItem(this.__namespace__+"master"),-1===this.__get_alive_router_ids__().indexOf(this.__master_id__)&&(this.__ls__.setItem(this.__namespace__+"master",this.__node_id__),this.__on_master_changed__(this.__node_id__))},e.exports=t},{"./local_storage":4}],6:[function(_,e,t){"use strict";function n(_){var e=this;this.__namespace__=_.namespace||"tabex_default_",this.__handlers__=[],this.__iframe_url__=_.iframe,this.__iframe_done__=!1,this.__pending__=[],this.__iframe__=document.createElement("iframe"),this.__iframe__.style.left="-1000px",this.__iframe__.style.position="absolute",this.__iframe__.onload=function(){e.__iframe__.contentWindow.postMessage({origin:window.location.origin,namespace:e.__namespace__},e.__iframe_url__),e.__iframe_done__=!0,e.__pending__.forEach(function(_){e.__iframe__.contentWindow.postMessage(_,e.__iframe_url__)}),e.__pending__=null},window.addEventListener("message",function(_){0===e.__iframe_url__.indexOf(_.origin)&&_.data.namespace===e.__namespace__&&e.__handlers__.forEach(function(e){e(_.data.channel,_.data.message)})}),this.__iframe__.src=this.__iframe_url__,document.addEventListener("DOMContentLoaded",function(){document.querySelector("body").appendChild(e.__iframe__)})}function i(_){var e,t=this;for(this.__namespace__=_.namespace||"tabex_default_",this.__origin_first_check__=_.origin||window.location.origin,Array.isArray(this.__origin_first_check__)||(this.__origin_first_check__=[this.__origin_first_check__]),e=0;e<this.__origin_first_check__.length;e++)this.__origin_first_check__[e]=this.__origin_first_check__[e].replace(/[-\/\\^$+?.()|[\]{}]/g,"\\$&"),this.__origin_first_check__[e]=this.__origin_first_check__[e].replace(/[*]/g,".+?"),this.__origin_first_check__[e]=new RegExp(this.__origin_first_check__[e]);this.__origin__=null,this.__router__=_.router,window.addEventListener("message",function(_){var n=!1;if(!t.__origin__||t.__origin__!==_.origin){for(e=0;e<t.__origin_first_check__.length;e++)if(t.__origin_first_check__[e].test(_.origin)){n=!0;break}if(!n)return}if(_.data.namespace===t.__namespace__)return!t.__origin__&&_.data.origin?(t.__origin__=_.data.origin,void t.__router__.onmessage(function(_,e){window.parent.postMessage({channel:_,message:e,namespace:t.__namespace__},t.__origin__)})):void t.__router__.broadcast(_.data.channel,_.data.message)})}n.prototype.broadcast=function(_,e){this.__iframe_done__?this.__iframe__.contentWindow.postMessage({channel:_,message:e,namespace:this.__namespace__},this.__iframe_url__):this.__pending__.push({channel:_,message:e,namespace:this.__namespace__})},n.prototype.onmessage=function(_){this.__handlers__.push(_)},t.TunnelClient=n,t.TunnelRouter=i},{}],7:[function(_,e,t){"use strict";t.asyncEach=function(_){function e(){if(0===_.length)return void t.apply(this,arguments);var n=_.shift();n.apply(this,Array.prototype.slice.call(arguments,0).concat(e))}_=_.slice(0);var t=arguments[arguments.length-1],n=Array.prototype.slice.call(arguments,1);n.pop(),e.apply(this,n)}},{}]},{},[1])(1)});